# Claude Code Instructions

## Project

**ki7mt-ai-lab-training** — Prophet V2 WSPR propagation prediction model training.

PyTorch neural network trained on WSPR (Weak Signal Propagation Reporter) spot data
joined with solar indices from ClickHouse to predict HF radio signal-to-noise ratio.

## Architecture

- **Model**: ResidualBlock network (2 blocks, 256-unit hidden, BatchNorm + skip connections)
- **Data source**: ClickHouse on 192.168.1.90 (`wspr.spots_raw` + `solar.indices_raw`)
- **Training hardware**: M3 Ultra Mac Studio (MPS backend)
- **Features**: 13 inputs (path geometry, frequency, solar, geography, interactions)

## Key Files

- `scripts/train_v2_pilot.py` — Training script (queries ClickHouse, builds features, trains model)
- `scripts/test_v2_sensitivity.py` — Sensitivity analysis (loads saved model, sweeps parameters)
- `prophet_v2.pth` — Saved model checkpoint (not committed, generated by training)

## Phase History

### Phase 1: Consolidation (COMPLETE)
- Resolved "Silent Sun" bug, Physics Gap, Blackwell driver mismatch
- Gold Standard dataset: `wspr.training_set_v1` (6M rows)

### Phase 2: Pilot Training (COMPLETE)
- V2.0: 11 features, 10M rows, RMSE 8.04 dB — inverted SSN response
- V2.1: 13 features, hash-ordered sampling, SSN-SNR r=+0.0143
- **Finding**: Data quality is the bottleneck (leaked bands 14%, SNR -99 to +60, ground-wave contamination)

### Phase 3: Data Purge (IN PROGRESS)
- SQL filters: `snr[-35,25]`, `band[1,15]`, `distance[500,18000]`
- Target: SSN-SNR Pearson correlation > 0.1

## Data Quality Notes

- `wspr.spots_raw.band` column contains leaked frequency values (MHz/kHz) for ~14% of raw rows
- `solar.indices_raw` only has SSN with meaningful 2020-2025 coverage (kp: 23 rows, sfi: 0, xray: 2026-01-27+ only)
- FixedString(8) grid values from ClickHouse require null-byte stripping and regex validation
- Band IDs 1-15 are standard ADIF codes; values outside this range are data quality issues

## Conventions

- Feature normalization constants are hardcoded (distance/20000, freq_log/8, ssn/300, etc.)
- Maidenhead grid conversion matches algorithm in `ki7mt-ai-lab-cuda/src/io/clickhouse_loader.cpp:27-77`
- Model checkpoint includes metadata: input_dim, hidden_dim, features list, date range, sample size, phase
